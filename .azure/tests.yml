parameters:
  netcore1Global: true

steps:
- task: DotNetCoreCLI@2
  displayName: dotnet build
  inputs:
    command: build
    projects: progaudi.tarantool.sln
    arguments: -c Release
    verbosityRestore: minimal

- task: Bash@3
  displayName: set version variable
  inputs:
    targetType: inline
    script: echo "##vso[task.setvariable variable=NugetPackageVersion]$(git describe --tags | sed 's/-/./')"

- task: DotNetCoreCLI@2
  displayName: pack nuget package
  inputs:
    command: pack
    versioningScheme: byEnvVar
    versionEnvVar: NugetPackageVersion
    arguments: --no-build -c Release /property:PackageOutputPath=$(Build.ArtifactStagingDirectory)
    verbosityPack: minimal

- task: Bash@3
  inputs:
    targetType: inline
    script: docker-compose up -d

- template: test.yml
  parameters:
    path: tests/progaudi.tarantool.tests/progaudi.tarantool.tests.csproj
    framework: netcoreapp1.0
    frameworkGlobal: ${{ parameters.netcore1Global }}

- template: test.yml
  parameters:
    path: tests/progaudi.tarantool.tests/progaudi.tarantool.tests.csproj
    framework: netcoreapp1.1
    frameworkGlobal: ${{ parameters.netcore1Global }}

- template: test.yml
  parameters:
    path: tests/progaudi.tarantool.tests/progaudi.tarantool.tests.csproj
    framework: netcoreapp2.0
